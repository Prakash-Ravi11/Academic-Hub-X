<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Academic Hub X - Smart Academic File Management</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="theme-color" content="#007AFF">
  <link rel="stylesheet" href="style.css">
  <!-- Load Supabase first, then QR scanner, then our app -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <style>
    /* Critical CSS for loading and auth */
    :root {
      --primary: #007AFF;
      --danger: #FF3B30;
      --success: #34C759;
      --gray-100: #F2F2F7;
      --gray-500: #8E8E93;
      --gray-700: #48484A;
      --gray-900: #1C1C1E;
      --shadow-heavy: 0 16px 60px rgba(0,0,0,0.3);
      --radius-large: 20px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .loading-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, var(--primary), #0056CC);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
    }

    .loading-logo {
      font-size: 3rem;
      margin-bottom: 2rem;
      animation: pulse 2s infinite;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

    .hero {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: white;
      padding: 2rem;
    }

    .hero-title {
      font-size: clamp(3rem, 8vw, 5rem);
      font-weight: 700;
      margin-bottom: 1.5rem;
    }

    .hero-subtitle {
      font-size: 1.3rem;
      margin-bottom: 3rem;
      opacity: 0.9;
      max-width: 600px;
    }

    .cta-container {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn-cta {
      padding: 1rem 2rem;
      border-radius: 12px;
      font-weight: 600;
      text-decoration: none;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      border: none;
      font-size: 1.1rem;
    }

    .btn-primary {
      background: white;
      color: var(--primary);
    }

    .btn-secondary {
      background: rgba(255,255,255,0.15);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
    }

    /* Auth Modal */
    .auth-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .auth-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .auth-panel {
      background: white;
      border-radius: var(--radius-large);
      padding: 2rem;
      max-width: 400px;
      width: calc(100% - 2rem);
      box-shadow: var(--shadow-heavy);
      position: relative;
    }

    .close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      color: var(--gray-500);
    }

    .auth-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .auth-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: var(--gray-900);
    }

    .auth-subtitle {
      color: var(--gray-500);
    }

    .auth-tabs {
      display: flex;
      background: var(--gray-100);
      border-radius: 12px;
      padding: 4px;
      margin-bottom: 2rem;
    }

    .auth-tab {
      flex: 1;
      padding: 0.75rem;
      border-radius: 8px;
      background: transparent;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      color: var(--gray-500);
    }

    .auth-tab.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .form-input {
      width: 100%;
      padding: 1rem;
      border: 2px solid #E5E5EA;
      border-radius: 12px;
      font-size: 1rem;
      transition: var(--transition);
      background: white;
      box-sizing: border-box;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .form-button {
      width: 100%;
      padding: 1rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .form-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .error-message {
      background: #FFE6E6;
      color: var(--danger);
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      border-left: 4px solid var(--danger);
    }

    .success-message {
      background: #E6F7E6;
      color: var(--success);
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      border-left: 4px solid var(--success);
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loadingScreen" class="loading-screen">
    <div class="loading-logo">ðŸŽ“</div>
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading Academic Hub X...</div>
  </div>

  <!-- Hero Landing -->
  <div id="hero" class="hero" style="display: none;">
    <div>
      <h1 class="hero-title">Academic Hub X</h1>
      <p class="hero-subtitle">
        The future of academic file management. Organize, sync, and access your study materials with intelligent categorization.
      </p>
      <div class="cta-container">
        <button class="btn-cta btn-primary" onclick="openAuth()">
          Get Started Free â†’
        </button>
      </div>
    </div>
  </div>

  <!-- Authentication Modal -->
  <div id="authModal" class="auth-modal">
    <div class="auth-panel">
      <button class="close-btn" onclick="closeAuth()">Ã—</button>
      
      <div class="auth-header">
        <h2 class="auth-title">Welcome Back</h2>
        <p class="auth-subtitle">Sign in to access your files</p>
      </div>

      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchTab('signin')">Sign In</button>
        <button class="auth-tab" onclick="switchTab('signup')">Sign Up</button>
      </div>

      <div id="errorMessage" class="error-message" style="display: none;"></div>
      <div id="successMessage" class="success-message" style="display: none;"></div>

      <!-- Sign In Form -->
      <form id="signinForm" onsubmit="handleSignIn(event)">
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <input type="email" class="form-input" id="signin-email" placeholder="Enter your email" required>
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-input" id="signin-password" placeholder="Enter your password" required>
        </div>
        <button type="submit" class="form-button" id="signinBtn">
          <span>Sign In</span>
        </button>
      </form>

      <!-- Sign Up Form -->
      <form id="signupForm" style="display: none;" onsubmit="handleSignUp(event)">
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <input type="text" class="form-input" id="signup-name" placeholder="Enter your full name" required>
        </div>
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <input type="email" class="form-input" id="signup-email" placeholder="Enter your email" required>
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-input" id="signup-password" placeholder="Create a password" required minlength="6">
        </div>
        <button type="submit" class="form-button" id="signupBtn">
          <span>Create Account</span>
        </button>
      </form>
    </div>
  </div>

  <script>
    // CRITICAL FIX: Initialize everything immediately, don't wait for libraries
    let supabase = null;
    let isInitialized = false;
    
    // Configuration - Replace with your actual credentials
    const SUPABASE_URL = 'https://yvlspahwnnzfctqqlmbu.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2bHNwYWh3bm56ZmN0cXFsbWJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNjQ4NzUsImV4cCI6MjA2OTk0MDg3NX0.5j6phM4WCe7XZo5xHdajwAShkV-hibECc_sp31JI6SQ';

    // FIXED: Force hide loading screen after maximum time
    setTimeout(() => {
      hideLoadingScreen();
    }, 3000); // 3 seconds maximum

    function hideLoadingScreen() {
      const loadingScreen = document.getElementById('loadingScreen');
      const hero = document.getElementById('hero');
      if (loadingScreen) {
        loadingScreen.style.display = 'none';
      }
      if (hero) {
        hero.style.display = 'flex';
      }
    }

    // FIXED: Initialize Supabase with proper error handling
    function initializeSupabase() {
      try {
        if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
            auth: {
              persistSession: true,
              autoRefreshToken: true,
              detectSessionInUrl: false // CRITICAL: Disable to prevent URL parsing errors
            }
          });
          console.log('Supabase initialized successfully');
        } else {
          console.warn('Supabase library not loaded');
        }
      } catch (error) {
        console.error('Supabase initialization failed:', error);
        // Continue without Supabase - don't block the app
      } finally {
        isInitialized = true;
        hideLoadingScreen();
      }
    }

    // Initialize when DOM is ready OR after timeout
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeSupabase);
    } else {
      initializeSupabase();
    }

    // Backup initialization after 1 second
    setTimeout(initializeSupabase, 1000);

    // Auth modal functions
    function openAuth() {
      document.getElementById('authModal').classList.add('active');
    }

    function closeAuth() {
      document.getElementById('authModal').classList.remove('active');
    }

    function switchTab(tab) {
      const signinTab = document.querySelector('.auth-tab:first-child');
      const signupTab = document.querySelector('.auth-tab:last-child');
      const signinForm = document.getElementById('signinForm');
      const signupForm = document.getElementById('signupForm');
      
      if (tab === 'signin') {
        signinTab.classList.add('active');
        signupTab.classList.remove('active');
        signinForm.style.display = 'block';
        signupForm.style.display = 'none';
      } else {
        signinTab.classList.remove('active');
        signupTab.classList.add('active');
        signinForm.style.display = 'none';
        signupForm.style.display = 'block';
      }
      clearMessages();
    }

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      document.getElementById('successMessage').style.display = 'none';
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('successMessage');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
      document.getElementById('errorMessage').style.display = 'none';
    }

    function clearMessages() {
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('successMessage').style.display = 'none';
    }

    // FIXED: Robust authentication with offline handling
    async function handleSignIn(event) {
      event.preventDefault();
      const email = document.getElementById('signin-email').value.trim();
      const password = document.getElementById('signin-password').value;
      const button = document.getElementById('signinBtn');
      
      // Disable button
      button.disabled = true;
      button.querySelector('span').textContent = 'Signing in...';
      clearMessages();
      
      try {
        // Check if we're online
        if (!navigator.onLine) {
          throw new Error('No internet connection. Please check your network and try again.');
        }
        
        // Check if Supabase is available
        if (!supabase) {
          throw new Error('Authentication service unavailable. Please refresh and try again.');
        }
        
        // Validate inputs
        if (!email || !password) {
          throw new Error('Please enter both email and password.');
        }
        
        // FIXED: Add timeout to prevent hanging
        const authPromise = supabase.auth.signInWithPassword({
          email: email,
          password: password
        });
        
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('Request timed out. Please try again.')), 10000);
        });
        
        const { data, error } = await Promise.race([authPromise, timeoutPromise]);
        
        if (error) {
          // Handle specific Supabase errors
          if (error.message.includes('Invalid login credentials')) {
            throw new Error('Invalid email or password. Please check your credentials.');
          } else if (error.message.includes('Email not confirmed')) {
            throw new Error('Please verify your email address first.');
          } else {
            throw new Error(error.message || 'Sign in failed. Please try again.');
          }
        }
        
        if (data?.user) {
          showSuccess('Sign in successful! Redirecting...');
          
          // Store user data
          const userData = {
            id: data.user.id,
            email: data.user.email,
            name: data.user.user_metadata?.full_name || data.user.email.split('@')[0]
          };
          
          localStorage.setItem('ahx_user', JSON.stringify(userData));
          
          // Redirect to app
          setTimeout(() => {
            window.location.href = 'app.html';
          }, 1000);
        } else {
          throw new Error('Sign in failed. Please try again.');
        }
        
      } catch (error) {
        console.error('Sign in error:', error);
        
        // FIXED: Better error messages for common issues
        let errorMessage = error.message;
        if (error.message.includes('fetch')) {
          errorMessage = 'Network error. Please check your connection and try again.';
        } else if (error.message.includes('JSON') || error.message.includes('Offline')) {
          errorMessage = 'Service temporarily unavailable. Please try again in a moment.';
        }
        
        showError(errorMessage);
      } finally {
        // Re-enable button
        button.disabled = false;
        button.querySelector('span').textContent = 'Sign In';
      }
    }

    // FIXED: Robust sign up
    async function handleSignUp(event) {
      event.preventDefault();
      const name = document.getElementById('signup-name').value.trim();
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value;
      const button = document.getElementById('signupBtn');
      
      button.disabled = true;
      button.querySelector('span').textContent = 'Creating account...';
      clearMessages();
      
      try {
        if (!navigator.onLine) {
          throw new Error('No internet connection. Please check your network and try again.');
        }
        
        if (!supabase) {
          throw new Error('Authentication service unavailable. Please refresh and try again.');
        }
        
        if (!name || !email || !password) {
          throw new Error('Please fill in all fields.');
        }
        
        if (password.length < 6) {
          throw new Error('Password must be at least 6 characters long.');
        }
        
        const authPromise = supabase.auth.signUp({
          email: email,
          password: password,
          options: {
            data: { full_name: name }
          }
        });
        
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('Request timed out. Please try again.')), 10000);
        });
        
        const { data, error } = await Promise.race([authPromise, timeoutPromise]);
        
        if (error) {
          if (error.message.includes('User already registered')) {
            throw new Error('An account with this email already exists. Please sign in instead.');
          } else {
            throw new Error(error.message || 'Sign up failed. Please try again.');
          }
        }
        
        if (data?.user) {
          showSuccess('Account created! Please check your email to verify your account.');
          // Switch to sign in tab after 3 seconds
          setTimeout(() => switchTab('signin'), 3000);
        }
        
      } catch (error) {
        console.error('Sign up error:', error);
        
        let errorMessage = error.message;
        if (error.message.includes('fetch')) {
          errorMessage = 'Network error. Please check your connection and try again.';
        } else if (error.message.includes('JSON') || error.message.includes('Offline')) {
          errorMessage = 'Service temporarily unavailable. Please try again in a moment.';
        }
        
        showError(errorMessage);
      } finally {
        button.disabled = false;
        button.querySelector('span').textContent = 'Create Account';
      }
    }

    // Network status monitoring
    window.addEventListener('online', () => {
      showSuccess('Connection restored!');
      setTimeout(clearMessages, 3000);
    });

    window.addEventListener('offline', () => {
      showError('You are offline. Please check your internet connection.');
    });
  </script>
</body>
</html>
